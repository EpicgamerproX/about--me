<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ice & Ember: Soft Body Physics</title>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@300;600&display=swap');
        
        :root { --accent: #ffae00; --bg: #050505; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background-color: var(--bg); 
            color: white; 
            font-family: 'Montserrat', sans-serif; 
            overflow: hidden; 
            height: 100vh; width: 100vw;
        }

        nav {
            position: fixed; top: 40px; left: 50%; transform: translateX(-50%);
            z-index: 100; display: flex; gap: 20px;
            background: rgba(10,10,10,0.8); padding: 12px 30px; border-radius: 100px;
            border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(20px);
        }
        .nav-btn {
            background: transparent; border: none; color: rgba(255,255,255,0.5);
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .nav-btn.active { color: white; text-shadow: 0 0 10px rgba(255,255,255,0.5); }

        .section {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; pointer-events: none; transition: opacity 1s ease;
        }
        .section.active { opacity: 1; pointer-events: all; }

        #portfolio-section { display: flex; justify-content: center; align-items: center; perspective: 1000px; }
        .ice-slab {
            width: 70vw; height: 60vh;
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
            border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
            transform: rotateX(20deg); box-shadow: 0 50px 100px black;
            display: flex; justify-content: center; align-items: center;
            position: relative;
        }
        .ice-text { text-align: center; }
        h1 { font-family: 'Playfair Display'; font-size: 4rem; margin-bottom: 10px; }
        
        #webgl-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10%; pointer-events: none;
        }
        .card {
            width: 280px; padding: 40px 30px;
            background: rgba(5,5,5,0.85); border-left: 4px solid var(--accent);
            backdrop-filter: blur(10px); color: #ddd;
            opacity: 0; transform: translateY(50px); transition: 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .section.active .card { opacity: 1; transform: translateY(0); }
        .card h3 { color: var(--accent); font-family: 'Playfair Display'; margin-bottom: 10px; font-size: 1.5rem; }
        .card p { font-size: 0.85rem; line-height: 1.6; color: #aaa; }

    </style>
</head>
<body>

    <nav>
        <button class="nav-btn active" onclick="setTab('portfolio')">Portfolio</button>
        <button class="nav-btn" onclick="setTab('projects')">Projects</button>
    </nav>

    <section id="portfolio-section" class="section active">
        <div class="ice-slab">
            <canvas id="frost-canvas" style="position: absolute; top:0; left:0; width:100%; height:100%; opacity: 0.4; mix-blend-mode: overlay;"></canvas>
            <div class="ice-text">
                <h1>THE FROST</h1>
                <p style="letter-spacing: 5px; opacity: 0.7;">DIGITAL DESIGN</p>
            </div>
        </div>
    </section>

    <section id="projects-section" class="section">
        <canvas id="webgl-canvas"></canvas>
        <div class="ui-layer">
            <div class="card" id="card-left">
                <h3>VINTAGE UI</h3>
                <p>Interfaces that feel physical. Tactile depth, realistic lighting, and glassmorphism.</p>
            </div>
            <div class="card" id="card-right">
                <h3>SOFT BODY</h3>
                <p>Full volumetric vertex displacement simulating liquid inertia and surface tension.</p>
            </div>
        </div>
    </section>

    <script type="module">
        import * as THREE from 'three';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';

        let currentTab = 'portfolio';
        // Physics variables for Inertia
        let mouse = { x: 0, y: 0 };
        let prevMouse = { x: 0, y: 0 };
        let acceleration = { x: 0, y: 0 };
        let velocity = { x: 0, y: 0 };

        const windowHalfX = window.innerWidth / 2;
        const windowHalfY = window.innerHeight / 2;

        // --- 1. FROST CANVAS ---
        const fC = document.getElementById('frost-canvas');
        const fX = fC.getContext('2d');
        let trails = [];
        const resizeFrost = () => { fC.width = fC.offsetWidth; fC.height = fC.offsetHeight; };
        window.addEventListener('resize', resizeFrost); resizeFrost();

        document.addEventListener('mousemove', (e) => {
            // Update Mouse Logic
            mouse.x = (e.clientX - windowHalfX) / windowHalfX;
            mouse.y = (e.clientY - windowHalfY) / windowHalfY;
            
            if(currentTab === 'portfolio') {
                const r = fC.getBoundingClientRect();
                trails.push({ x: e.clientX - r.left, y: e.clientY - r.top, a: 0.5 });
            }
        });

        function renderIce() {
            fX.clearRect(0,0, fC.width, fC.height);
            trails.forEach(t => {
                t.a -= 0.01; fX.beginPath(); fX.arc(t.x, t.y, 30, 0, 7);
                fX.fillStyle = `rgba(255,255,255,${t.a})`; fX.fill();
            });
            trails = trails.filter(t => t.a > 0);
            requestAnimationFrame(renderIce);
        }
        renderIce();


        // --- 2. 3D ENGINE ---
        const canvas = document.querySelector('#webgl-canvas');
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.8;

        const scene = new THREE.Scene();

        // HDRI
        new RGBELoader()
            .setPath('https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/')
            .load('studio_small_09_1k.hdr', function (texture) {
                texture.mapping = THREE.EquirectangularReflectionMapping;
                scene.environment = texture;
            });

        const camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 0.1, 100);
        camera.position.set(0, 3, 14);

        const glassGroup = new THREE.Group();
        glassGroup.position.y = -2.5; 
        scene.add(glassGroup);

        // --- MATERIALS (Visibility & Clarity Fix) ---
        const glassMat = new THREE.MeshPhysicalMaterial({
            color: 0xffffff,
            transmission: 1.0,  
            thickness: 0.05, // Ultra thin for clarity
            roughness: 0,
            ior: 1.5,
            clearcoat: 1.0,
            transparent: true,
            side: THREE.FrontSide
        });

        const liquidMat = new THREE.MeshPhysicalMaterial({
            color: 0xff9900,
            transmission: 0.8, 
            thickness: 1.5,    
            roughness: 0.1,
            ior: 1.2, // Slightly lower IOR helps visibility inside glass
            attenuationColor: new THREE.Color(0xcc6600), 
            attenuationDistance: 5.0,
            transparent: true,
            side: THREE.DoubleSide // Ensure we see back and front of waves
        });

        const iceMat = new THREE.MeshPhysicalMaterial({
            transmission: 0.9, roughness: 0.1, thickness: 1.5, ior: 1.31,
            color: 0xffffff, clearcoat: 0.5
        });

        // --- GEOMETRY ---

        // Glass Cup
        const cupProfile = [
            new THREE.Vector2(0, 0),    
            new THREE.Vector2(3, 0),    
            new THREE.Vector2(3.2, 5),  
            new THREE.Vector2(3.0, 5),  
            new THREE.Vector2(2.8, 0.5),
            new THREE.Vector2(0, 0.5)   
        ];
        const cupGeo = new THREE.LatheGeometry(cupProfile, 64);
        const cup = new THREE.Mesh(cupGeo, glassMat);
        cup.renderOrder = 2; 
        glassGroup.add(cup);

        // LIQUID - HIGH POLY FOR SOFT BODY PHYSICS
        // RadiusTop, RadiusBot, Height, RadialSegments, HeightSegments (Important!)
        // HeightSegments = 20 means we have 20 layers of nodes to bend!
        const liquidGeo = new THREE.CylinderGeometry(2.85, 2.65, 2.8, 64, 20);
        
        // Store original positions for physics calculations
        const posAttribute = liquidGeo.attributes.position;
        const originalPositions = [];
        for (let i = 0; i < posAttribute.count; i++) {
            originalPositions.push({
                x: posAttribute.getX(i),
                y: posAttribute.getY(i),
                z: posAttribute.getZ(i)
            });
        }

        const liquid = new THREE.Mesh(liquidGeo, liquidMat);
        liquid.position.y = 1.8; 
        liquid.renderOrder = 1;  
        glassGroup.add(liquid);

        // Ice Cube
        const iceGeo = new THREE.BoxGeometry(1.6, 1.6, 1.6);
        const iceCube = new THREE.Mesh(iceGeo, iceMat);
        iceCube.position.set(0, 1.5, 0);
        iceCube.rotation.set(0.5, 0.5, 0);
        glassGroup.add(iceCube);

        // --- LIGHTING ---
        const backLight = new THREE.PointLight(0xffffff, 60);
        backLight.position.set(0, 5, -10);
        scene.add(backLight);

        const innerLight = new THREE.PointLight(0xffaa00, 20);
        innerLight.position.set(0, 2, 0); // Inside the drink
        glassGroup.add(innerLight);

        const fillLight = new THREE.DirectionalLight(0xffaa00, 3);
        fillLight.position.set(-5, 5, 5);
        scene.add(fillLight);

        const cardL = document.getElementById('card-left');
        const cardR = document.getElementById('card-right');

        function animate() {
            requestAnimationFrame(animate);

            if(currentTab === 'projects') {
                // --- 1. CALCULATE INERTIA ---
                // Calculate acceleration based on mouse change
                acceleration.x = (mouse.x - prevMouse.x) * 0.05;
                acceleration.y = (mouse.y - prevMouse.y) * 0.05;

                // Add to velocity with damping (spring effect)
                velocity.x += acceleration.x;
                velocity.x *= 0.95; // Decay
                velocity.y += acceleration.y;
                velocity.y *= 0.95; // Decay

                // Save prev mouse
                prevMouse.x = mouse.x;
                prevMouse.y = mouse.y;

                // --- 2. SOFT BODY ALGORITHM ---
                const time = Date.now() * 0.003;
                const positions = liquidGeo.attributes.position;

                for (let i = 0; i < positions.count; i++) {
                    const orig = originalPositions[i];
                    
                    // "Height Factor": 0 at bottom, 1 at top.
                    // This ensures the bottom stays stuck to the glass, top moves most.
                    const heightFactor = (orig.y + 1.4) / 2.8; 
                    const normalizedHeight = Math.max(0, heightFactor); 

                    // Wave Noise
                    const noise = Math.sin(orig.x * 2 + time) * 0.05 + Math.cos(orig.z * 1.5 + time) * 0.05;
                    
                    // --- THE ALGORITHM: AFFECT NODES THROUGHOUT ---
                    
                    // 1. Shear/Slosh: Top moves opposite to velocity (lag)
                    const shearX = -velocity.x * normalizedHeight * 8.0; 
                    const shearZ = velocity.y * normalizedHeight * 4.0; // Y mouse maps to Z depth

                    // 2. Bulge: When liquid sloshes, sides expand outward
                    // We calculate distance from center to know which way is "out"
                    const angle = Math.atan2(orig.z, orig.x);
                    const dist = Math.sqrt(orig.x*orig.x + orig.z*orig.z);
                    
                    // Dynamic Bulge based on velocity
                    const bulgeAmount = (Math.abs(velocity.x) + Math.abs(velocity.y)) * normalizedHeight * 0.5;
                    const bulgeX = Math.cos(angle) * bulgeAmount * Math.sin(normalizedHeight * Math.PI); // Sin ensures bulge is in middle
                    const bulgeZ = Math.sin(angle) * bulgeAmount * Math.sin(normalizedHeight * Math.PI);

                    // 3. Top Surface Turbulence (Only if y is high)
                    let surfaceY = 0;
                    if(orig.y > 1.3) {
                        surfaceY = noise + (orig.x * -velocity.x * 2); // Tilt surface
                    }

                    // Apply New Positions
                    positions.setX(i, orig.x + shearX + bulgeX);
                    positions.setZ(i, orig.z + shearZ + bulgeZ);
                    positions.setY(i, orig.y + surfaceY);
                }

                positions.needsUpdate = true;
                liquidGeo.computeVertexNormals();

                // Rotate Glass
                glassGroup.rotation.y += (mouse.x * 0.3 - glassGroup.rotation.y) * 0.05;
                glassGroup.rotation.x += (mouse.y * 0.1 - glassGroup.rotation.x) * 0.05;

                // Ice Physics
                iceCube.rotation.y += 0.005;
                iceCube.position.y = 1.5 + Math.sin(time * 0.5) * 0.1;
                // Ice reacts to inertia too
                iceCube.position.x += (shearX_Calc(1) - iceCube.position.x) * 0.1;

                // Parallax UI
                cardL.style.transform = `translate(${mouse.x * -40}px, ${mouse.y * -20}px)`;
                cardR.style.transform = `translate(${mouse.x * -60}px, ${mouse.y * -30}px)`;

                renderer.render(scene, camera);
            }
        }
        
        // Helper for ice physics
        function shearX_Calc(h) { return -velocity.x * h * 4.0; }

        animate();

        window.setTab = (t) => {
            currentTab = t;
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(t + '-section').classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        };

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
